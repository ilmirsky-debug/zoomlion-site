import { useState, useEffect } from "react";

export default function Admin() {
  const [stock, setStock] = useState([]);
  const [loading, setLoading] = useState(true);
  const [newItem, setNewItem] = useState({
    title: "",
    desc: "",
    price: "",
    img: "",
  });

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
  useEffect(() => {
    fetch("/stock/stock.json?cache_bust=" + Date.now())
      .then((res) => res.json())
      .then((data) => {
        setStock(data);
        setLoading(false);
      })
      .catch((err) => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err));
  }, []);

  // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π
  const handleChange = (index, field, value) => {
    const updated = [...stock];
    updated[index][field] = value;
    setStock(updated);
  };

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ç–µ—Ö–Ω–∏–∫–∏
  const addNewItem = () => {
    if (!newItem.title || !newItem.price) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É");
      return;
    }
    setStock([...stock, newItem]);
    setNewItem({ title: "", desc: "", price: "", img: "" });
  };

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  const saveChanges = async () => {
    const res = await fetch("/api/update-stock", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(stock, null, 2),
    });
    if (res.ok) alert("‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
    else alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
  };

  if (loading) return <p className="text-center mt-10">–ó–∞–≥—Ä—É–∑–∫–∞...</p>;

  return (
    <div className="max-w-4xl mx-auto py-10 px-6">
      <h1 className="text-2xl font-bold mb-6 text-center">–ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ—Ö–Ω–∏–∫–∏</h1>

      {stock.map((item, i) => (
        <div key={i} className="mb-6 p-4 border rounded-lg shadow-sm">
          <input
            type="text"
            value={item.title}
            onChange={(e) => handleChange(i, "title", e.target.value)}
            className="w-full border p-2 mb-2 rounded"
            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏"
          />
          <textarea
            value={item.desc}
            onChange={(e) => handleChange(i, "desc", e.target.value)}
            className="w-full border p-2 mb-2 rounded"
            placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"
          />
          <input
            type="text"
            value={item.price}
            onChange={(e) => handleChange(i, "price", e.target.value)}
            className="w-full border p-2 mb-2 rounded font-mono"
            placeholder="–¶–µ–Ω–∞"
          />
          <input
            type="text"
            value={item.img}
            onChange={(e) => handleChange(i, "img", e.target.value)}
            className="w-full border p-2 mb-2 rounded"
            placeholder="–ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä /stock/fd30.jpg"
          />
        </div>
      ))}

      <h2 className="text-xl font-semibold mb-2 mt-10">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ç–µ—Ö–Ω–∏–∫—É</h2>
      <div className="p-4 border rounded-lg shadow-sm mb-6">
        <input
          type="text"
          value={newItem.title}
          onChange={(e) => setNewItem({ ...newItem, title: e.target.value })}
          className="w-full border p-2 mb-2 rounded"
          placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏"
        />
        <textarea
          value={newItem.desc}
          onChange={(e) => setNewItem({ ...newItem, desc: e.target.value })}
          className="w-full border p-2 mb-2 rounded"
          placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"
        />
        <input
          type="text"
          value={newItem.price}
          onChange={(e) => setNewItem({ ...newItem, price: e.target.value })}
          className="w-full border p-2 mb-2 rounded"
          placeholder="–¶–µ–Ω–∞"
        />
        <input
          type="text"
          value={newItem.img}
          onChange={(e) => setNewItem({ ...newItem, img: e.target.value })}
          className="w-full border p-2 mb-2 rounded"
          placeholder="–ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä /stock/fd30.jpg"
        />
        <button
          onClick={addNewItem}
          className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-400 transition"
        >
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </div>

      <button
        onClick={saveChanges}
        className="bg-lime-500 text-white px-6 py-2 rounded-lg hover:bg-lime-400 transition"
      >
        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
      </button>
    </div>
  );
}
